name: Generate vendored content for the release

on:
  release:
    types: [published]

jobs:
  generate-and-publish-vendored-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate cargo vendored tarball
        run: |
          tag=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          tarball_name="guest-components-${tag}-vendor.tar.gz"
          vendor_dir_list=""
          for i in $(find . -name 'Cargo.lock'); do
            dir="$(dirname i)"
            pushd ${dir}
              [ -d .cargo ] || mkdir .cargo
              cargo vendor >> .cargo/config.toml
              vendor_dir_list+=" ${dir}/vendor ${dir}/.cargo/config.toml"
            popd
          done

          tar -cvzf ${tarball_name} ${vendor_dir_list}
          gh release upload ${tag} ${tarball_name}
        env:
          GH_TOKEN: ${{ github.token }}
